<html>
<head>
	<meta http-equiv="content-type" charset="Shift_JIS">
	<title>次は君の番だ！</title> 
	<script language="javascript" type="text/javascript">
	//こういうグローバルな変数を安易に増やすと死ぬ
	var mode = 0; //1:未使用の席の設定、2:運用中
	var shimei_count = [];
	var yoko,tate;

	function Onconfig () {
		var target = document.getElementById("config");
		var target_form = document.getElementById("getname");
		var i,j;

		yoko = document.getElementById("config_yoko").value;
		tate = document.getElementById("config_tate").value;

		//指名カウンターを用意する
		for (i = 0;i < tate ; i++) {
			shimei_count[i] = [];

			for (j = 0;j < yoko ; j++) {
				shimei_count[i][j] = {counter:0,student_name:""};
				//console.log("shimei_count[" + String(i) + "][" + String(j) + "]");
			}
		}

		//まずは未使用の席の設定
		mode = 1;

		target.innerHTML = "<input type=\"button\" value=\"開始する\" onclick=\"Onconfig_start()\"/>";
		target_form.innerHTML = "";

		show_shimei_table(-1,-1);
	}

	function get_and_set_name () {
		var fileInput = document.getElementById('getfile');
		var target_config = document.getElementById("config");
		var target_form = document.getElementById("getname");
		var fileReader = new FileReader();
		var file = fileInput.files[0];
		var no_kaigou_str = "";
		var i,j = 0;
		fileReader.onload = function (event) {

			var name_array = [];
			var name_string = fileReader.result.split('\n');
			for (i = 0; i < name_string.length; i++) {
				name_array[i] = name_string[i].split(',');
			}

			tate = name_string.length;
			yoko = name_array[0].length;

			//指名カウンターを用意する
			for (i = 0;i < tate ; i++) {
				shimei_count[i] = [];

				for (j = 0;j < yoko ; j++) {
					shimei_count[i][j] = {counter:0,student_name:""};
					//console.log("shimei_count[" + String(i) + "][" + String(j) + "]");
				}
			}

			for (i = 0;i < tate ; i++) {
				for (j = 0;j < yoko ; j++) {
					if (name_array[i][j].match("-")) { //== "-" でチェックすると、\rが悪さをすることがある
						shimei_count[i][j].counter = -1;
					} else {
						shimei_count[i][j].student_name = name_array[i][j];
					}
				}
			}

			target_config.innerHTML = "<input type=\"button\" value=\"誰か選ぶ\" onclick=\"Onconfig_choice()\"/>";
			target_form.innerHTML = "";
			//運用開始
			mode = 2;

			show_shimei_table(-1,-1);
		}
		fileReader.readAsText(file);
	}

	function Onconfig_start () {
		var target = document.getElementById("config");
		var target_form = document.getElementById("getname");
		var form = document.forms.getfileform;

		//運用開始
		mode = 2;

		target.innerHTML = "<input type=\"button\" value=\"誰か選ぶ\" onclick=\"Onconfig_choice()\"/>";
		target_form.innerHTML = "";

		show_shimei_table(-1,-1);
	}

	function Onconfig_choice () {
		seki = choice_zaseki();

		shimei_count[seki.tate][seki.yoko].counter = shimei_count[seki.tate][seki.yoko].counter + 1;

		show_shimei_table(seki.tate, seki.yoko);
	}
	function OnZasekiClick(i, j) {
		var target = document.getElementById("config");

		switch(mode) {
			case 1://未使用の席の設定
				shimei_count[i][j].counter = -1;
				break;
			case 2://運用中
				shimei_count[i][j].counter = shimei_count[i][j].counter + 1;
				break;
		}
		show_shimei_table(-1,-1);
	}
	function show_shimei_table(i_,j_) {
		var target_filed = document.getElementById("table_filed");
		var temp;

		//なぜかtarget_filed.innerHTMLに直接文字列を連結していくと、タグ部分が認識されない。
		//後で調査すること
		temp = "<table border=1 width = \"75%\" height = \"75%\" >";
		for (i = 0;i < tate ; i++) {
			temp += "<tr>";

			for (j = 0;j < yoko ; j++) {

				temp += "<td bgcolor=\"" + getcolor(shimei_count[i][j].counter) + "\">";

				switch(mode) {
					case 1://未使用の席の設定
						temp += "<span onclick=\"OnZasekiClick(" + String(i) + "," + String(j) + ")\">" + "この席は未使用です" + "</span>" +  "</td>";
						break;
					case 2://運用中
						if (shimei_count[i][j].counter != -1) {
							if (i_ == i && j_ == j) {
//								temp += "<span onclick=\"OnZasekiClick(" + String(i) + "," + String(j) + ")\">" + "次は君の番だ！" + "回数:" + String(shimei_count[i][j].counter) + "</span>" +  "</td>";
								temp += "<span onclick=\"OnZasekiClick(" + String(i) + "," + String(j) + ")\">" + shimei_count[i][j].student_name + " 次は君の番だ！" + "　　　" + "</span>" +  "</td>";
							} else
//								temp += "<span onclick=\"OnZasekiClick(" + String(i) + "," + String(j) + ")\">" + "回数:" + String(shimei_count[i][j].counter) + "</span>" +  "</td>";
								temp += "<span onclick=\"OnZasekiClick(" + String(i) + "," + String(j) + ")\">" + shimei_count[i][j].student_name + "　　　"  + "</span>" +  "</td>";
							}
						break;
				}
			}
			temp += "</tr>";
		}
		temp += "</table>";
		target_filed.innerHTML = temp;
	}

	function getcolor(n) {
		var color = "";

		switch (n) {
			case -1:
				color += "#808080";
				break;
			case 0:
				color += "#ffffff";
				break;
			case 1:
				color += "#ffff00";
				break;
			case 2:
				color += "#ff4500";
				break;
			case 3:
				color += "#c71585";
				break;
			default:
				color += "#4b0082";
					break;
		}
		return color;
	}
	//未使用の席を除いた席の数を数える
	function count_zaseki() {
		var counter = 0;

		for (i = 0;i < tate ; i++) {
			for (j = 0;j < yoko ; j++) {
				if (shimei_count[i][j].counter != -1) {
					counter = counter + 1;
				}
			}
		}
		return counter;
	}
	//使用中の席から一つをランダムで選ぶ
	//ダサいのでこのへんもう少し考える
	function choice_zaseki() {
		var temp = get_random_Integer(0, count_zaseki() - 1);
		var exit_flg = 0;
		var seki;

		for (i = 0;i < tate ; i++) {
			for (j = 0;j < yoko ; j++) {
				if (shimei_count[i][j].counter != -1) {

					if (temp != 0) {
						temp = temp -1;
					} else {
						seki = {tate : i,
							yoko : j}
						exit_flg = 1;
						break;
					}
				}
			}

			if (exit_flg == 1) {
				break;
			}
		}
		return seki;
	}


	//minからmaxまでの整数からランダムに選んで出力する。
	function get_random_Integer(min, max) {
		var range = (max + 1) - min;
		//お勉強めも。Math.randomは0<=x<1の中からランダムな値を返す。
		//が、ガチなランダムではないでセキュリティが求められるものには使えない。
		//Math.flooraは小数点以下の切り捨て
		var rand = Math.floor(Math.random() * range) + min;
		return rand;
	}

	window.onload = function() {
		var target = document.getElementById("config");
		var target_form = document.getElementById("getname");

		target.innerHTML = "横に";
		target.innerHTML += "<input type=\"text\" id=\"config_yoko\" value=\"\" size=\"3\" maxlength=\"3\"/>";
		target.innerHTML += "列、縦に";
		target.innerHTML += "<input type=\"text\" id=\"config_tate\" value=\"\" size=\"3\" maxlength=\"3\"/>";
		target.innerHTML += "列　";
		target.innerHTML += "<input type=\"button\" value=\"設定\" onclick=\"Onconfig()\"/>";

		target_form.innerHTML = "<form><input type=\"file\" id=\"getfile\" onchange=\"get_and_set_name()\"/></form>(csvを指定する。未使用席は\"-\"。EOFは最後の行につけておく（最後に改行しない）。文字コードがutf-8でないと文字化けするので注意)";

	}

</script>
<style>
	table {
		table-layout: fixed;     /* 固定レイアウト */
	}
</style>
</head>
<body>
<h1>次は君の番だ！</h1>
<p id="config">
</p>
<p id="table_filed">
</p>
<p id="getname">
</p>
</body>
</html>
